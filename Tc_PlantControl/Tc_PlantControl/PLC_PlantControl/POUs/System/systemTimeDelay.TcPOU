<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1" ProductVersion="3.1.4024.13">
  <POU Name="systemTimeDelay" Id="{aced55d1-560c-4812-a22f-5aa1b529dde2}" SpecialFunc="None">
    <Declaration><![CDATA[FUNCTION_BLOCK systemTimeDelay
VAR_INPUT
    DelayTime : LREAL;   // Desired delay in seconds
    Start     : BOOL;    // Start signal (must stay TRUE to complete delay)
    Reset     : BOOL;    // Resets latched state and timer
END_VAR

VAR_OUTPUT
    IsElapsed     : BOOL;    // Latches TRUE after timeout, until reset
    RemainingTime : LREAL;   // Countdown in seconds (0 if not running)
END_VAR

VAR
    StartEdge       : BOOL;
    PrevStart       : BOOL;
    StartTime       : ULINT;   // Time when timer started (µs)
    ElapsedTimeRaw  : ULINT;   // Raw elapsed time in microseconds
    ElapsedSeconds  : LREAL;   // Elapsed time in seconds
    IsRunning       : BOOL;
END_VAR
]]></Declaration>
    <Implementation>
      <ST><![CDATA[// Detect rising edge of Start
StartEdge := Start AND NOT PrevStart;
PrevStart := Start;

// Reset everything if Reset = TRUE
IF Reset THEN
    IsElapsed := FALSE;
    IsRunning := FALSE;
    RemainingTime := 0.0;
END_IF

// If Start goes low during active timing, cancel and reset
IF NOT Start AND IsRunning THEN
    IsRunning := FALSE;
    RemainingTime := 0.0;
END_IF

// Start timer on rising edge of Start
IF StartEdge AND NOT IsElapsed THEN
    StartTime := F_GetSystemTime();  // System time in microseconds
    IsRunning := TRUE;
END_IF

// Timing logic
IF IsRunning THEN
    ElapsedTimeRaw := F_GetSystemTime() - StartTime;       // Time difference in µs
    ElapsedSeconds := ElapsedTimeRaw / 10000000.0;          // Convert to seconds

    IF ElapsedSeconds >= DelayTime THEN
        IsElapsed := TRUE;
        IsRunning := FALSE;
        RemainingTime := 0.0;
    ELSE
        RemainingTime := DelayTime - ElapsedSeconds;
    END_IF
END_IF
]]></ST>
    </Implementation>
    <LineIds Name="systemTimeDelay">
      <LineId Id="155" Count="35" />
      <LineId Id="9" Count="0" />
    </LineIds>
  </POU>
</TcPlcObject>